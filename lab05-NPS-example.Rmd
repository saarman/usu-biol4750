---
title: "Lab 5: Spatial Statistics"
author: "Norah Saarman"
date: "2024-10-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Section 5.4 Exercise
https://bookdown.org/hhwagner1/LandGenCourse_book/r-exercise-week-2.html

## a. Load libraries
```{r}
library(LandGenCourse)
#library(EcoGenetics)
library(GeNetIt)
library(hierfstat)
library(adegenet)
require(gstudio)       
require(dplyr)
require(tibble) 
require(sf)
require(popgraph)
require(RgoogleMaps)
require(geosphere)
require(proto)
require(sampling)
require(seqinr)
require(spacetime)
require(spdep)
require(here)
```

b. Import to adegenet object with gstudio
```{r}
library(gstudio)
library(adegenet)

# 1. CSV file "./downloads/pulsatilla_genotypes.csv" --> data frame 
# with "gstudio" function read_population()
g.Flr <- read_population("./downloads/pulsatilla_genotypes.csv",
                       type = "column",locus.columns = c(6:19))

# 2. Select only adults with base R indexing of data frame 
# rows where OffID==0, all columns
g.Flr <- g.Flr[g.Flr$OffID==0,]

# 3. Nothing to do here

# 4. Create genind object with "adegenet" function df2genind() 
# using NA.char = ""
g.Flr.genind <- df2genind(X=g.Flr[,c(6:12)], sep=":", ncode=NULL, ind.names=g.Flr$ID, loc.names=NULL, pop=g.Flr$Population, NA.char="", ploidy=2, type="codom", strata=NULL, hierarchy=NULL)

# 5. Check genind object
g.Flr.genind
summary(g.Flr.genind)
```
Without G-Studio, Drop offspring
Using adegenet and base R
```{r}
library(adegenet)

# 1. CSV file "./downloads/pulsatilla_genotypes.csv" --> data frame 
# with base R function read.csv()
Flr <- read.csv("./downloads/pulsatilla_genotypes.csv", header=TRUE)

# 2. Select only adults with base R indexing of data frame 
# rows where OffID==0, all columns
Flr <- Flr[Flr$OffID==0,]

# 3. Combine columns with base R function paste()
Flr <- data.frame(Flr[,1:5],loc1 = paste(Flr[,6],  Flr[,7], sep=":"), 
                            loc2 = paste(Flr[,8],  Flr[,9], sep=":"), 
                            loc3 = paste(Flr[,10], Flr[,11], sep=":"), 
                            loc4 = paste(Flr[,12], Flr[,13], sep=":"), 
                            loc5 = paste(Flr[,14], Flr[,15], sep=":"),  
                            loc6 = paste(Flr[,16], Flr[,17], sep=":"),  
                            loc7 = paste(Flr[,18], Flr[,19], sep=":"))
# 4. Create genind object with "adegenet" function df2genind() 
# using NA.char = "NA"
Flr.genind <- df2genind(X=Flr[,c(6:12)], sep=":", ncode=NULL, ind.names= Flr$ID, loc.names=names(Flr[,c(6:12)]), pop=Flr$Population, NA.char="NA", ploidy=2, type="codom", strata=NULL, hierarchy=NULL)

# 5. Check genind object
Flr.genind

Flr.genind@pop

summary(Flr.genind)
```

c. PLot locations of individuals from site A25
From dataframe
```{r}
# Select data for Population "A25"
Sites <- Flr[Flr$Population == "A25", c("X", "Y")]

# Check if the data frame has valid coordinates
head(Sites)

# Convert to an 'sf' object
Pulsatilla <- st_as_sf(Sites, coords = c("X", "Y"), crs = 31468) 

# Confirm the CRS was set correctly
st_crs(Pulsatilla)

# Transform to WGS84 (lat/long, EPSG:4326)
Pulsatilla_latlon <- st_transform(Pulsatilla, crs = 4326)
```
# d. Add geographic info to genind object

Genind object @other can hold a list such as spatial coordinates
```{r}

# Convert data frame of xy coordinates from Flr into a matrix of xy coordinates
xy_matrix <- as.matrix(Flr[, c("X", "Y")])

# Add the matrix to the @other slot with the name "xy"
Flr.genind@other <- list(xy = xy_matrix)

# Check the class of the @other slot
class(Flr.genind@other)  # Should return "list"

# Inspect the genind object and its summary
print(Flr.genind)
summary(Flr.genind)
```

# e. Calculate genetic and geographic euclidean distance (for Site A25)
Genetic with adegenet::propShared
```{r}
#Check genind object
Flr.genind
summary(Flr.genind)

# Subset only site A25
Flr.A25 <- Flr.genind[Flr.genind@pop == "A25"]

# Calculate genetic distance
ind.dist <- adegenet::propShared(Flr.A25)
ind.dist <- as.dist(1-ind.dist)
class(ind.dist)
```

Geographic with dist()
```{r}
# We have already changed coordinates and subset A25
# Extract coordinates from the sf object as a matrix
coords_wgs84 <- st_coordinates(Pulsatilla_latlon)

# Print the extracted WGS84 coordinates to verify
print(coords_wgs84)

# Calculate the Euclidean distance using dist()
euclidean_distances <- dist(coords_wgs84, method = "euclidean")

# Print the Euclidean distance matrix
print(euclidean_distances)

# Convert to a full matrix if needed
dist_matrix <- as.matrix(euclidean_distances)
print(dist_matrix)


```
