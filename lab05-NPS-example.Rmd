---
title: "Lab 5: Spatial Statistics"
author: "Norah Saarman"
date: "2024-10-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Section 5.4 Exercise
https://bookdown.org/hhwagner1/LandGenCourse_book/r-exercise-week-2.html

## a. Load libraries
```{r}
library(LandGenCourse)
#library(EcoGenetics)
library(GeNetIt)
library(hierfstat)
library(adegenet)
require(gstudio)       
require(dplyr)
require(tibble) 
require(sf)
require(popgraph)
require(RgoogleMaps)
require(geosphere)
require(proto)
require(sampling)
require(seqinr)
require(spacetime)
require(spdep)
require(here)
```

## b. Import to adegenet object Using adegenet and base R, Without G-Studio, Drop offspring:
```{r}
library(adegenet)

# 1. CSV file "./downloads/pulsatilla_genotypes.csv" --> data frame 
# with base R function read.csv()
Flr <- read.csv("./downloads/pulsatilla_genotypes.csv", header=TRUE)

# 2. Select only adults with base R indexing of data frame 
# rows where OffID==0, all columns
Flr <- Flr[Flr$OffID==0,]

# 3. Combine columns with base R function paste()
Flr <- data.frame(Flr[,1:5],loc1 = paste(Flr[,6],  Flr[,7], sep=":"), 
                            loc2 = paste(Flr[,8],  Flr[,9], sep=":"), 
                            loc3 = paste(Flr[,10], Flr[,11], sep=":"), 
                            loc4 = paste(Flr[,12], Flr[,13], sep=":"), 
                            loc5 = paste(Flr[,14], Flr[,15], sep=":"),  
                            loc6 = paste(Flr[,16], Flr[,17], sep=":"),  
                            loc7 = paste(Flr[,18], Flr[,19], sep=":"))
# 4. Create genind object with "adegenet" function df2genind() 
# using NA.char = "NA"
Flr.genind <- df2genind(X=Flr[,c(6:12)], sep=":", ncode=NULL, ind.names= Flr$ID, loc.names=names(Flr[,c(6:12)]), pop=Flr$Population, NA.char="NA", ploidy=2, type="codom", strata=NULL, hierarchy=NULL)

# 5. Check genind object
Flr.genind

Flr.genind@pop

summary(Flr.genind)
```

## c. Plot locations of individuals from site A25 From data frame
```{r}
# Select data for Population "A25"
Sites <- Flr[Flr$Population == "A25", c("X", "Y")]

# Check if the data frame has valid coordinates
head(Sites)

# Convert to an 'sf' object
Sites_sf <- st_as_sf(Sites, coords = c("X", "Y"), crs = 31468) 

# Confirm the CRS was set correctly
st_crs(Sites_sf)

# Transform to WGS84 (lat/long, EPSG:4326)
Sites_latlon <- st_transform(Sites_sf, crs = 4326)
```
# d. Add geographic info to genind object

Genind object @other can hold a list such as spatial coordinates
```{r}
# Select xy coordinates from Flr
Sites <- Flr[, c("X", "Y")]

# Convert to an 'sf' object with the correct original CRS (replace 31468 if needed)
Sites_sf <- st_as_sf(Sites, coords = c("X", "Y"), crs = 31468)

# Transform to WGS84 (lat/lon, EPSG:4326)
Sites_latlon <- st_transform(Sites_sf, crs = 4326)

# Extract coordinates from the transformed sf object
latlon_matrix <- st_coordinates(Sites_latlon)

# Convert to a matrix with column names "longitude" and "latitude"
colnames(latlon_matrix) <- c("longitude", "latitude")

# Add the matrix to the @other slot with the name "xy"
Flr.genind@other <- list(xy = latlon_matrix)

# Check the class of the @other slot
print(class(Flr.genind@other))  # Should return "list"

# Inspect the genind object and its summary
print(Flr.genind)
```

## e. Calculate genetic and geographic euclidean distance (for Site A25)
I can't tell if we are meant to proceed with just population A25? If so, I would first subset like this:
```{r}
# Subset only site A25
Flr.A25 <- Flr.genind[Flr.genind@pop == "A25"]
```
 
For now I'll proceed with the full genind object.

### Genetic distance with adegenet::propShared:
```{r}
# Calculate genetic distance matrix
Dgen_matrix <- adegenet::propShared(Flr.A25)

# Convert to a distance vector (1 - proportion shared)
Dgen <- as.vector(1 - Dgen_matrix)
```

### Geographic with dist()

### One option is to use the @other slot for lat long
```{r}
# Extract the 'xy' matrix from the @other slot
xy_matrix <- Flr.genind@other$xy

# Convert the matrix back into a data frame
df_xy <- as.data.frame(xy_matrix)
```

### Other (simpler) option is to pull from the original data frame
```{r}
df_xy <- Flr[Flr$Population == "A25", c("X","Y")]
```

```{r}
colnames(df_xy) <- c("X", "Y") 

# Calculate Euclidean geographic distances
Dgeo <- as.vector(dist(df_xy))
```

Adapt section 4a to Visualize
```{r}
# Load necessary packages
library(MASS)  # For kde2d()
library(scales)  # For transparent colors using alpha

# Step 5: Check visual linearity
par(mar = c(4, 4, 0, 0))  # Adjust plot margins

# Generate density for better visualization
dens <- kde2d(Dgeo, Dgen, n = 300)

length(Dgeo)
length(Dgen)

# CrDgeo# Create a color palette
myPal <- colorRampPalette(c("white", "blue", "gold", "orange", "red"))

# Plot geographic vs genetic distance
plot(Dgeo, Dgen, pch = 20, cex = 0.5,  
     xlab = "Geographic Distance", ylab = "Genetic Distance")

# Add density image with transparency
image(dens, col = alpha(myPal(300), 0.7), add = TRUE)

# Add linear regression line
abline(lm(Dgen ~ Dgeo), col = "black")

# Add loess smoothing line in red
lines(loess.smooth(Dgeo, Dgen), col = "red")
```
